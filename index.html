<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>X_FAZI TEXTURE MAKER</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #080808;
  --s1:       #0e0e0e;
  --s2:       #141414;
  --s3:       #1c1c1c;
  --border:   #1f1f1f;
  --border2:  #2a2a2a;
  --text:     #e8e8e8;
  --dim:      #444;
  --mid:      #777;
  --hi:       #ffffff;
  --accent:   #c8ff00;  
  --mono:     'JetBrains Mono', monospace;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  background:var(--bg);
  color:var(--text);
  font-family:var(--mono);
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  font-size:13px;
}
header{
  height:48px;
  display:flex;
  align-items:center;
  padding:0 20px;
  border-bottom:1px solid var(--border);
  background:var(--s1);
  gap:16px;
  flex-shrink:0;
  position:relative;
}
header::after{
  content:'';
  position:absolute;
  bottom:0; left:0; right:0;
  height:1px;
  background:linear-gradient(90deg,var(--accent),transparent 60%);
  opacity:.4;
}

.logo{
  font-family:'Bebas Neue',sans-serif;
  font-size:20px;
  letter-spacing:5px;
  color:var(--hi);
  white-space:nowrap;
}
.logo em{color:var(--accent);font-style:normal}

.header-sep{width:1px;height:20px;background:var(--border2)}

.header-tag{
  font-size:9px;
  letter-spacing:3px;
  color:var(--dim);
  text-transform:uppercase;
}

.header-right{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:12px;
}

.kbd{
  background:var(--s3);
  border:1px solid var(--border2);
  color:var(--mid);
  font-family:var(--mono);
  font-size:9px;
  padding:2px 6px;
  letter-spacing:1px;
}
.workspace{display:flex;flex:1;overflow:hidden}
.panel{
  width:228px;
  flex-shrink:0;
  border-right:1px solid var(--border);
  background:var(--s1);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

.panel-scroll{
  flex:1;
  overflow-y:auto;
  overflow-x:hidden;
}
.panel-scroll::-webkit-scrollbar{width:3px}
.panel-scroll::-webkit-scrollbar-thumb{background:var(--s3)}

.sec{
  padding:14px 14px 12px;
  border-bottom:1px solid var(--border);
}

.sec-title{
  font-size:8px;
  letter-spacing:3px;
  color:var(--dim);
  text-transform:uppercase;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  gap:6px;
}
.sec-title::after{
  content:'';flex:1;height:1px;
  background:linear-gradient(90deg,var(--border2),transparent);
}
.tools-grid{display:flex;flex-wrap:wrap;gap:5px}

.tbtn{
  width:44px;height:44px;
  background:var(--s2);
  border:1px solid var(--border2);
  color:var(--mid);
  font-size:17px;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .12s;
  position:relative;
  flex-shrink:0;
}
.tbtn:hover{background:var(--s3);border-color:var(--mid);color:var(--hi)}
.tbtn.on{background:var(--s3);border-color:var(--accent);color:var(--hi);box-shadow:0 0 0 1px var(--accent) inset}

.tbtn .tt{
  position:absolute;
  bottom:-28px; left:50%;transform:translateX(-50%);
  background:var(--s3);border:1px solid var(--border2);
  color:var(--mid);font-size:8px;letter-spacing:1px;
  padding:2px 7px;white-space:nowrap;
  pointer-events:none;opacity:0;transition:opacity .15s;z-index:20;
}
.tbtn:hover .tt{opacity:1}
.color-row{display:flex;gap:10px;align-items:center;margin-bottom:10px}

.c-swatch{
  width:52px;height:52px;
  border:1px solid var(--border2);
  cursor:pointer;
  flex-shrink:0;
  position:relative;
  overflow:hidden;
  transition:border-color .15s;
}
.c-swatch:hover{border-color:var(--mid)}
.c-swatch input{
  position:absolute;inset:0;
  opacity:0;cursor:pointer;
  width:100%;height:100%;
}
.c-info{flex:1;min-width:0}
.c-hex{
  font-size:14px;font-weight:500;
  color:var(--hi);letter-spacing:1px;margin-bottom:3px;
}
.c-label{font-size:9px;color:var(--dim);letter-spacing:2px}
.bw-row{display:flex;gap:3px;flex-wrap:wrap}
.bw-dot{
  width:20px;height:20px;cursor:pointer;
  border:1px solid transparent;
  transition:transform .1s,border-color .1s;
  flex-shrink:0;
}
.bw-dot:hover{transform:scale(1.2);border-color:var(--mid)}
.bw-dot.on{border-color:var(--accent)!important;transform:scale(1.15)}
.palette-wrap{display:flex;flex-wrap:wrap;gap:4px;min-height:22px}
.pal-dot{
  width:22px;height:22px;cursor:pointer;
  border:1px solid transparent;
  transition:transform .1s,border-color .1s;
  flex-shrink:0;
}
.pal-dot:hover{transform:scale(1.25);border-color:var(--mid)}
.pal-dot.on{border-color:var(--accent)!important}
.pal-empty{font-size:9px;color:var(--dim);letter-spacing:2px;padding:2px 0}

.pal-actions{display:flex;gap:5px;margin-top:8px}
.pal-btn{
  flex:1;
  background:var(--s2);border:1px solid var(--border2);
  color:var(--mid);font-family:var(--mono);
  font-size:8px;letter-spacing:2px;
  padding:5px 4px;cursor:pointer;
  transition:all .1s;text-transform:uppercase;
}
.pal-btn:hover{border-color:var(--accent);color:var(--accent)}
.img-drop{
  border:1px dashed var(--border2);
  padding:14px 10px;
  text-align:center;
  cursor:pointer;
  background:var(--s2);
  transition:all .2s;
}
.img-drop:hover{border-color:var(--accent);background:var(--s3)}
.img-drop.has-img{padding:8px}
.img-drop-icon{font-size:24px;margin-bottom:5px}
.img-drop-text{font-size:9px;color:var(--mid);letter-spacing:2px}

.extract-preview{
  width:100%;height:60px;
  object-fit:cover;
  display:block;
  image-rendering:pixelated;
  margin-bottom:6px;
}

.extract-count{
  font-size:9px;color:var(--accent);letter-spacing:2px;
  text-align:center;margin-bottom:6px;
}

.extract-btn{
  width:100%;
  background:var(--accent);
  border:none;
  color:#000;
  font-family:'Bebas Neue',sans-serif;
  font-size:15px;letter-spacing:3px;
  padding:8px;cursor:pointer;
  transition:opacity .1s;
}
.extract-btn:hover{opacity:.85}
.extract-btn:disabled{opacity:.3;cursor:not-allowed}
.ref-drop{
  border:1px dashed var(--border2);
  padding:12px 10px;
  text-align:center;
  cursor:pointer;
  background:var(--s2);
  transition:all .2s;
}
.ref-drop:hover{border-color:var(--mid)}

.ref-controls{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.ref-slider-row{display:flex;align-items:center;gap:8px}
.ref-slider-label{font-size:9px;color:var(--dim);letter-spacing:1px;width:42px}
input[type=range]{
  flex:1;height:3px;
  accent-color:var(--accent);
  background:var(--s3);
  cursor:pointer;
}
.ref-val{font-size:10px;color:var(--mid);width:28px;text-align:right}

.pos-btns{display:flex;gap:4px;flex-wrap:wrap}
.pos-btn{
  flex:1;min-width:40px;
  background:var(--s2);border:1px solid var(--border2);
  color:var(--mid);font-family:var(--mono);
  font-size:8px;letter-spacing:1px;
  padding:4px 2px;cursor:pointer;
  transition:all .1s;text-align:center;
  text-transform:uppercase;
}
.pos-btn:hover{border-color:var(--mid);color:var(--hi)}
.pos-btn.on{border-color:var(--accent);color:var(--accent);background:var(--s3)}
.size-row{display:flex;gap:6px;align-items:flex-end}
.size-field{flex:1}
.size-field label{
  display:block;font-size:9px;color:var(--dim);
  letter-spacing:2px;margin-bottom:4px;
}
.size-input{
  width:100%;
  background:var(--s2);border:1px solid var(--border2);
  color:var(--hi);font-family:var(--mono);
  font-size:15px;padding:6px 8px;text-align:center;
  outline:none;transition:border-color .1s;
}
.size-input:focus{border-color:var(--accent)}
.size-sep{color:var(--dim);font-size:16px;padding-bottom:7px}
.zoom-row{display:flex;align-items:center;gap:8px}
.zbtn{
  width:30px;height:30px;
  background:var(--s2);border:1px solid var(--border2);
  color:var(--mid);font-size:18px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .1s;flex-shrink:0;
}
.zbtn:hover{border-color:var(--accent);color:var(--accent)}
.zval{flex:1;text-align:center;font-size:13px;color:var(--mid);letter-spacing:1px}
.panel-bottom{
  border-top:1px solid var(--border);
  padding:12px 14px;
  display:flex;flex-direction:column;gap:6px;
}
.export-btn{
  background:var(--hi);border:none;
  color:#000;
  font-family:'Bebas Neue',sans-serif;
  font-size:17px;letter-spacing:5px;
  padding:10px;cursor:pointer;
  transition:all .15s;width:100%;
}
.export-btn:hover{background:var(--accent);color:#000}
.clear-btn{
  background:transparent;
  border:1px solid var(--border2);
  color:var(--dim);font-family:var(--mono);
  font-size:9px;letter-spacing:2px;
  padding:6px;cursor:pointer;
  width:100%;transition:all .1s;text-transform:uppercase;
}
.clear-btn:hover{border-color:var(--mid);color:var(--mid)}
.canvas-area{
  flex:1;
  display:flex;align-items:center;justify-content:center;
  overflow:auto;
  background:var(--bg);
  position:relative;
}

.canvas-area::before{
  content:'';position:absolute;inset:0;
  background-image:radial-gradient(circle,var(--border) 1px,transparent 1px);
  background-size:28px 28px;
  opacity:.5;pointer-events:none;
}

#pixel-canvas{
  cursor:crosshair;display:block;
  image-rendering:pixelated;
  position:relative;z-index:1;
  box-shadow:0 0 0 1px var(--border2),0 8px 60px rgba(0,0,0,.9);
}

#ref-overlay{
  position:absolute;
  z-index:10;
  pointer-events:none;
  border:1px solid rgba(255,255,255,.15);
  box-shadow:0 4px 24px rgba(0,0,0,.7);
  image-rendering:pixelated;
}

.statusbar{
  height:26px;
  border-top:1px solid var(--border);
  background:var(--s1);
  display:flex;align-items:center;
  padding:0 16px;gap:20px;flex-shrink:0;
}
.si{font-size:9px;color:var(--dim);letter-spacing:1px}
.si span{color:var(--mid)}
.apply-btn{
  width:100%;
  background:var(--s2);border:1px solid var(--border2);
  color:var(--mid);font-family:var(--mono);
  font-size:9px;letter-spacing:2px;
  padding:7px;cursor:pointer;
  margin-top:8px;transition:all .1s;text-transform:uppercase;
}
.apply-btn:hover{border-color:var(--accent);color:var(--accent)}
</style>
</head>
<body>
<header>
  <div class="logo">X_<em>FAZI</em> TEXTURE MAKER</div>
  <div class="header-sep"></div>
  <div class="header-tag">Pixel Editor v2</div>
  <div class="header-right">
    <span class="kbd">P pencil</span>
    <span class="kbd">E eraser</span>
    <span class="kbd">F fill</span>
    <span class="kbd">I eyedrop</span>
    <span class="kbd">scroll zoom</span>
  </div>
</header>
<div class="workspace">
  <div class="panel">
  <div class="panel-scroll">
    <div class="sec">
      <div class="sec-title">Tools</div>
      <div class="tools-grid">
        <button class="tbtn on" id="tool-pencil" onclick="setTool('pencil')">‚úèÔ∏è<span class="tt">PENCIL [P]</span></button>
        <button class="tbtn" id="tool-eraser" onclick="setTool('eraser')">üßπ<span class="tt">ERASER [E]</span></button>
        <button class="tbtn" id="tool-fill" onclick="setTool('fill')">ü™£<span class="tt">FILL [F]</span></button>
        <button class="tbtn" id="tool-eyedropper" onclick="setTool('eyedropper')">üíâ<span class="tt">EYEDROP [I]</span></button>
      </div>
    </div>
    <div class="sec">
      <div class="sec-title">Active Color</div>
      <div class="color-row">
        <div class="c-swatch" id="c-swatch">
          <input type="color" id="color-picker" value="#ffffff" oninput="setColor(this.value)">
        </div>
        <div class="c-info">
          <div class="c-hex" id="c-hex">#FFFFFF</div>
          <div class="c-label">HEX VALUE</div>
        </div>
      </div>
      <div class="bw-row" id="bw-row"></div>
    </div>
    <div class="sec">
      <div class="sec-title">Used Colors</div>
      <div class="palette-wrap" id="palette-wrap">
        <div class="pal-empty">pick a color to start</div>
      </div>
      <div class="pal-actions">
        <button class="pal-btn" onclick="clearPalette()">Clear</button>
        <button class="pal-btn" onclick="sortPalette()">Sort</button>
      </div>
    </div>
    <div class="sec">
      <div class="sec-title">Extract from Image</div>
      <div class="img-drop" id="extract-drop"
        onclick="document.getElementById('extract-file').click()"
        ondrop="onExtractDrop(event)" ondragover="event.preventDefault()">
        <div id="extract-inner">
          <div class="img-drop-icon">üé®</div>
          <div class="img-drop-text">DROP IMAGE OR CLICK</div>
        </div>
      </div>
      <input type="file" id="extract-file" accept="image/*" style="display:none"
        onchange="loadExtractImage(this.files[0])">
      <div id="extract-controls" style="display:none;margin-top:8px">
        <div class="sec-title" style="margin-bottom:6px">Max colors</div>
        <div class="zoom-row" style="margin-bottom:8px">
          <button class="zbtn" onclick="changeExtractCount(-4)">‚àí</button>
          <div class="zval" id="extract-count-val">16</div>
          <button class="zbtn" onclick="changeExtractCount(4)">+</button>
        </div>
        <button class="extract-btn" id="extract-btn" onclick="extractColors()">Extract Colors</button>
      </div>
    </div>
    <div class="sec">
      <div class="sec-title">Reference Image</div>
      <div class="ref-drop" id="ref-drop"
        onclick="document.getElementById('ref-file').click()"
        ondrop="onRefDrop(event)" ondragover="event.preventDefault()">
        <div id="ref-inner">
          <div class="img-drop-icon" style="font-size:20px">üñºÔ∏è</div>
          <div class="img-drop-text">DROP REFERENCE</div>
        </div>
      </div>
      <input type="file" id="ref-file" accept="image/*" style="display:none"
        onchange="loadRefImage(this.files[0])">

      <div id="ref-controls" style="display:none">
        <div class="ref-controls">
          <div class="ref-slider-row">
            <div class="ref-slider-label">SIZE</div>
            <input type="range" id="ref-size" min="60" max="320" value="140" oninput="updateRefOverlay()">
            <div class="ref-val" id="ref-size-val">140</div>
          </div>
          <div class="ref-slider-row">
            <div class="ref-slider-label">OPACITY</div>
            <input type="range" id="ref-opacity" min="10" max="100" value="70" oninput="updateRefOverlay()">
            <div class="ref-val" id="ref-opacity-val">70</div>
          </div>
          <div class="sec-title" style="margin:6px 0 4px">Position</div>
          <div class="pos-btns">
            <div class="pos-btn on" id="pos-tl" onclick="setRefPos('tl')">‚Üñ TL</div>
            <div class="pos-btn" id="pos-tr" onclick="setRefPos('tr')">‚Üó TR</div>
            <div class="pos-btn" id="pos-bl" onclick="setRefPos('bl')">‚Üô BL</div>
            <div class="pos-btn" id="pos-br" onclick="setRefPos('br')">‚Üò BR</div>
          </div>
          <button class="clear-btn" style="margin-top:6px" onclick="removeRef()">Remove Reference</button>
        </div>
      </div>
    </div>
    <div class="sec">
      <div class="sec-title">Canvas Size</div>
      <div class="size-row">
        <div class="size-field">
          <label>WIDTH</label>
          <input class="size-input" type="number" id="inp-w" value="16" min="1" max="256">
        </div>
        <div class="size-sep">√ó</div>
        <div class="size-field">
          <label>HEIGHT</label>
          <input class="size-input" type="number" id="inp-h" value="16" min="1" max="256">
        </div>
      </div>
      <button class="apply-btn" onclick="applySize()">Apply New Size</button>
    </div>
    <div class="sec">
      <div class="sec-title">Zoom</div>
      <div class="zoom-row">
        <button class="zbtn" onclick="chZoom(-1)">‚àí</button>
        <div class="zval" id="z-val">24√ó</div>
        <button class="zbtn" onclick="chZoom(1)">+</button>
      </div>
    </div>

  </div>
    <div class="panel-bottom">
      <button class="export-btn" onclick="exportPNG()">EXPORT PNG</button>
      <button class="clear-btn" onclick="clearCanvas()">Clear Canvas</button>
    </div>
  </div>
  <div class="canvas-area" id="canvas-area">
    <canvas id="pixel-canvas"></canvas>
    <img id="ref-overlay" style="display:none">
  </div>
</div>
<div class="statusbar">
  <div class="si">TOOL: <span id="st-tool">PENCIL</span></div>
  <div class="si">POS: <span id="st-pos">‚Äî</span></div>
  <div class="si">CANVAS: <span id="st-size">16√ó16</span></div>
  <div class="si">COLORS: <span id="st-colors">0</span></div>
  <div class="si">ZOOM: <span id="st-zoom">24√ó</span></div>
</div>

<script>
let W=16,H=16,ZOOM=24;
let tool='pencil';
let color='#ffffff';
let pixels=[];
let painting=false;
let lastCell=null;
let usedColors=[];
let extractCount=16;
let refPos='tl';
let extractImgEl=null;

const ZOOMS=[1,2,3,4,6,8,10,12,16,20,24,32,40,48,64];
let zIdx=10;

const BW=[
  '#ffffff','#e0e0e0','#c0c0c0','#a0a0a0',
  '#808080','#606060','#404040','#202020','#000000'
];

function init(){
  pixels=makeEmpty(W,H);
  buildBW();
  setColor('#ffffff');
  render();
  updateStatus();
}

function makeEmpty(w,h){
  return Array.from({length:h},()=>Array(w).fill(''));
}

function buildBW(){
  const row=document.getElementById('bw-row');
  row.innerHTML='';
  BW.forEach(h=>{
    const d=document.createElement('div');
    d.className='bw-dot'+(h===color?' on':'');
    d.style.background=h; d.title=h;
    d.onclick=()=>setColor(h);
    row.appendChild(d);
  });
}

function render(){
  const cv=document.getElementById('pixel-canvas');
  cv.width=W*ZOOM; cv.height=H*ZOOM;
  const ctx=cv.getContext('2d');
  ctx.imageSmoothingEnabled=false;

  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const c=pixels[y][x];
      ctx.fillStyle=c||((x+y)%2===0?'#181818':'#121212');
      ctx.fillRect(x*ZOOM,y*ZOOM,ZOOM,ZOOM);
    }
  }

  if(ZOOM>=5){
    ctx.strokeStyle='rgba(255,255,255,0.03)';
    ctx.lineWidth=1;
    for(let x=0;x<=W;x++){ctx.beginPath();ctx.moveTo(x*ZOOM,0);ctx.lineTo(x*ZOOM,H*ZOOM);ctx.stroke();}
    for(let y=0;y<=H;y++){ctx.beginPath();ctx.moveTo(0,y*ZOOM);ctx.lineTo(W*ZOOM,y*ZOOM);ctx.stroke();}
  }
}

function setTool(t){
  tool=t;
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('on'));
  document.getElementById('tool-'+t).classList.add('on');
  document.getElementById('st-tool').textContent=t.toUpperCase();
  const cv=document.getElementById('pixel-canvas');
  cv.style.cursor=t==='fill'?'copy':t==='eyedropper'?'cell':'crosshair';
}

function cell(e){
  const cv=document.getElementById('pixel-canvas');
  const r=cv.getBoundingClientRect();
  const x=Math.floor((e.clientX-r.left)/ZOOM);
  const y=Math.floor((e.clientY-r.top)/ZOOM);
  return(x<0||x>=W||y<0||y>=H)?null:{x,y};
}

function applyAt(x,y){
  if(tool==='pencil'){pixels[y][x]=color;addUsed(color);}
  else if(tool==='eraser'){pixels[y][x]='';}
  else if(tool==='eyedropper'){if(pixels[y][x])setColor(pixels[y][x]);setTool('pencil');return;}
  else if(tool==='fill'){flood(x,y,pixels[y][x],color);addUsed(color);}
  render();
}

function flood(x,y,target,fill){
  if(target===fill)return;
  const stack=[[x,y]],seen=new Set();
  while(stack.length){
    const[cx,cy]=stack.pop();
    const k=cx+','+cy;
    if(seen.has(k)||cx<0||cx>=W||cy<0||cy>=H||pixels[cy][cx]!==target)continue;
    seen.add(k);pixels[cy][cx]=fill;
    stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
  }
}
function setColor(h){
  color=h;
  document.getElementById('color-picker').value=h;
  document.getElementById('c-hex').textContent=h.toUpperCase();
  document.getElementById('c-swatch').style.background=h;
  document.querySelectorAll('.bw-dot').forEach(d=>d.classList.toggle('on',d.title.toLowerCase()===h.toLowerCase()));
  refreshPalette();
}

function addUsed(h){
  if(!usedColors.includes(h)){
    usedColors.unshift(h);
    if(usedColors.length>48)usedColors.pop();
    renderPalette();
    document.getElementById('st-colors').textContent=usedColors.length;
  }
}

function renderPalette(){
  const w=document.getElementById('palette-wrap');
  if(!usedColors.length){w.innerHTML='<div class="pal-empty">pick a color to start</div>';return;}
  w.innerHTML='';
  usedColors.forEach(h=>{
    const d=document.createElement('div');
    d.className='pal-dot'+(h===color?' on':'');
    d.style.background=h;d.title=h.toUpperCase();
    d.onclick=()=>setColor(h);
    w.appendChild(d);
  });
}

function refreshPalette(){
  document.querySelectorAll('.pal-dot').forEach(d=>
    d.classList.toggle('on',d.title.toLowerCase()===color.toLowerCase())
  );
}

function clearPalette(){usedColors=[];renderPalette();document.getElementById('st-colors').textContent=0;}
function sortPalette(){
  usedColors.sort((a,b)=>{
    const ha=hexToHsl(a)[0],hb=hexToHsl(b)[0];return ha-hb;
  });
  renderPalette();
}

function hexToHsl(hex){
  let r=parseInt(hex.slice(1,3),16)/255;
  let g=parseInt(hex.slice(3,5),16)/255;
  let b=parseInt(hex.slice(5,7),16)/255;
  const max=Math.max(r,g,b),min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min){h=s=0;}
  else{
    const d=max-min;
    s=l>.5?d/(2-max-min):d/(max+min);
    if(max===r)h=((g-b)/d+(g<b?6:0))/6;
    else if(max===g)h=((b-r)/d+2)/6;
    else h=((r-g)/d+4)/6;
  }
  return[h*360,s,l];
}
function changeExtractCount(d){
  extractCount=Math.max(4,Math.min(64,extractCount+d));
  document.getElementById('extract-count-val').textContent=extractCount;
}

function onExtractDrop(e){
  e.preventDefault();
  const f=e.dataTransfer.files[0];
  if(f&&f.type.startsWith('image/'))loadExtractImage(f);
}

function loadExtractImage(file){
  if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      extractImgEl=img;
      const inner=document.getElementById('extract-inner');
      inner.innerHTML=`<img class="extract-preview" src="${ev.target.result}">`;
      document.getElementById('extract-controls').style.display='block';
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
}

function extractColors(){
  if(!extractImgEl)return;
  const size=64;
  const cv=document.createElement('canvas');
  cv.width=size;cv.height=size;
  const ctx=cv.getContext('2d');
  ctx.drawImage(extractImgEl,0,0,size,size);
  const data=ctx.getImageData(0,0,size,size).data;
  const colorMap={};
  for(let i=0;i<data.length;i+=4){
    if(data[i+3]<128)continue;
    // Quantize to reduce noise
    const r=Math.round(data[i]/16)*16;
    const g=Math.round(data[i+1]/16)*16;
    const b=Math.round(data[i+2]/16)*16;
    const key=`${r},${g},${b}`;
    colorMap[key]=(colorMap[key]||0)+1;
  }
  const sorted=Object.entries(colorMap)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,extractCount);

  const extracted=sorted.map(([k])=>{
    const[r,g,b]=k.split(',').map(Number);
    return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
  });
  extracted.forEach(h=>{
    if(!usedColors.includes(h)){
      usedColors.push(h);
    }
  });
  if(usedColors.length>48)usedColors=usedColors.slice(0,48);
  renderPalette();
  document.getElementById('st-colors').textContent=usedColors.length;
  const btn=document.getElementById('extract-btn');
  btn.textContent='‚úì '+extracted.length+' COLORS ADDED';
  btn.style.background='#7fff7f';
  setTimeout(()=>{btn.textContent='Extract Colors';btn.style.background='';},1800);
}

function onRefDrop(e){
  e.preventDefault();
  const f=e.dataTransfer.files[0];
  if(f&&f.type.startsWith('image/'))loadRefImage(f);
}

function loadRefImage(file){
  if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const overlay=document.getElementById('ref-overlay');
    overlay.src=ev.target.result;
    overlay.style.display='block';
    document.getElementById('ref-inner').innerHTML=
      `<img src="${ev.target.result}" style="width:100%;height:50px;object-fit:cover;display:block">
       <div class="img-drop-text" style="padding:4px 0">CLICK TO REPLACE</div>`;
    document.getElementById('ref-controls').style.display='block';
    updateRefOverlay();
  };
  reader.readAsDataURL(file);
}

function updateRefOverlay(){
  const overlay=document.getElementById('ref-overlay');
  if(overlay.style.display==='none')return;

  const sz=parseInt(document.getElementById('ref-size').value);
  const op=parseInt(document.getElementById('ref-opacity').value);
  document.getElementById('ref-size-val').textContent=sz;
  document.getElementById('ref-opacity-val').textContent=op;

  overlay.style.width=sz+'px';
  overlay.style.height='auto';
  overlay.style.opacity=(op/100);

  positionRef();
}

function setRefPos(pos){
  refPos=pos;
  document.querySelectorAll('.pos-btn').forEach(b=>b.classList.remove('on'));
  document.getElementById('pos-'+pos).classList.add('on');
  positionRef();
}

function positionRef(){
  const overlay=document.getElementById('ref-overlay');
  const area=document.getElementById('canvas-area');
  const pad=12;

  overlay.style.top='';overlay.style.left='';
  overlay.style.bottom='';overlay.style.right='';

  if(refPos==='tl'){overlay.style.top=pad+'px';overlay.style.left=pad+'px';}
  else if(refPos==='tr'){overlay.style.top=pad+'px';overlay.style.right=pad+'px';}
  else if(refPos==='bl'){overlay.style.bottom=pad+'px';overlay.style.left=pad+'px';}
  else if(refPos==='br'){overlay.style.bottom=pad+'px';overlay.style.right=pad+'px';}
}

function removeRef(){
  document.getElementById('ref-overlay').style.display='none';
  document.getElementById('ref-inner').innerHTML=
    '<div class="img-drop-icon" style="font-size:20px">üñºÔ∏è</div><div class="img-drop-text">DROP REFERENCE</div>';
  document.getElementById('ref-controls').style.display='none';
}

function applySize(){
  const nw=Math.max(1,Math.min(256,parseInt(document.getElementById('inp-w').value)||16));
  const nh=Math.max(1,Math.min(256,parseInt(document.getElementById('inp-h').value)||16));
  const np=Array.from({length:nh},(_,y)=>
    Array.from({length:nw},(_,x)=>(y<H&&x<W)?pixels[y][x]:'')
  );
  W=nw;H=nh;pixels=np;
  const area=document.getElementById('canvas-area');
  const fw=Math.floor((area.clientWidth-40)/W);
  const fh=Math.floor((area.clientHeight-40)/H);
  const fit=Math.min(fw,fh);
  const ci=ZOOMS.reduce((pi,z,i)=>Math.abs(z-fit)<Math.abs(ZOOMS[pi]-fit)?i:pi,0);
  zIdx=ci; ZOOM=ZOOMS[zIdx];

  updateStatus();render();
}


function chZoom(d){
  zIdx=Math.max(0,Math.min(ZOOMS.length-1,zIdx+d));
  ZOOM=ZOOMS[zIdx];
  document.getElementById('z-val').textContent=ZOOM+'√ó';
  document.getElementById('st-zoom').textContent=ZOOM+'√ó';
  render();
}


function exportPNG(){
  const cv=document.createElement('canvas');
  cv.width=W;cv.height=H;
  const ctx=cv.getContext('2d');
  ctx.clearRect(0,0,W,H);
  for(let y=0;y<H;y++)for(let x=0;x<W;x++)if(pixels[y][x]){
    ctx.fillStyle=pixels[y][x];ctx.fillRect(x,y,1,1);
  }
  cv.toBlob(blob=>{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=`xfazi_${W}x${H}.png`;
    document.body.appendChild(a);a.click();
    document.body.removeChild(a);URL.revokeObjectURL(url);
  },'image/png');
}

function clearCanvas(){
  if(!confirm('Clear the canvas?'))return;
  pixels=makeEmpty(W,H);render();
}


function updateStatus(){
  document.getElementById('st-size').textContent=`${W}√ó${H}`;
  document.getElementById('z-val').textContent=ZOOM+'√ó';
  document.getElementById('st-zoom').textContent=ZOOM+'√ó';
}

const cv=document.getElementById('pixel-canvas');

cv.addEventListener('mousedown',e=>{
  painting=true;
  const c=cell(e);if(c){applyAt(c.x,c.y);lastCell=c;}
});

cv.addEventListener('mousemove',e=>{
  const c=cell(e);
  if(c){
    document.getElementById('st-pos').textContent=`${c.x},${c.y}`;
    if(painting&&(tool==='pencil'||tool==='eraser')){
      if(!lastCell||lastCell.x!==c.x||lastCell.y!==c.y){applyAt(c.x,c.y);lastCell=c;}
    }
  } else document.getElementById('st-pos').textContent='‚Äî';
});

cv.addEventListener('mouseleave',()=>{document.getElementById('st-pos').textContent='‚Äî';});
window.addEventListener('mouseup',()=>{painting=false;lastCell=null;});

// Wheel zoom
document.getElementById('canvas-area').addEventListener('wheel',e=>{
  e.preventDefault();chZoom(e.deltaY<0?1:-1);
},{passive:false});

// Keys
window.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT')return;
  if(e.key==='p'||e.key==='P')setTool('pencil');
  if(e.key==='e'||e.key==='E')setTool('eraser');
  if(e.key==='f'||e.key==='F')setTool('fill');
  if(e.key==='i'||e.key==='I')setTool('eyedropper');
  if(e.key==='+'||e.key==='=')chZoom(1);
  if(e.key==='-')chZoom(-1);
});

// BOOT
init();
window.addEventListener('load',()=>setTimeout(applySize,50));
</script>
</body>
</html>
